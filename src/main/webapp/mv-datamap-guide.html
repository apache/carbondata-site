<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href='images/favicon.ico' rel='shortcut icon' type='image/x-icon'>
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>CarbonData</title>
    <style>

    </style>
    <!-- Bootstrap -->

    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link href="css/style.css" rel="stylesheet">
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.scom/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <script src="js/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script defer src="https://use.fontawesome.com/releases/v5.0.8/js/all.js"></script>


</head>
<body>
<header>
    <nav class="navbar navbar-default navbar-custom cd-navbar-wrapper">
        <div class="container">
            <div class="navbar-header">
                <button aria-controls="navbar" aria-expanded="false" data-target="#navbar" data-toggle="collapse"
                        class="navbar-toggle collapsed" type="button">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a href="index.html" class="logo">
                    <img src="images/CarbonDataLogo.png" alt="CarbonData logo" title="CarbocnData logo"/>
                </a>
            </div>
            <div class="navbar-collapse collapse cd_navcontnt" id="navbar">
                <ul class="nav navbar-nav navbar-right navlist-custom">
                    <li><a href="index.html" class="hidden-xs"><i class="fa fa-home" aria-hidden="true"></i> </a>
                    </li>
                    <li><a href="index.html" class="hidden-lg hidden-md hidden-sm">Home</a></li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle " data-toggle="dropdown" role="button" aria-haspopup="true"
                           aria-expanded="false"> Download <span class="caret"></span></a>
                        <ul class="dropdown-menu">
                            <li>
                                <a href="https://dist.apache.org/repos/dist/release/carbondata/1.6.0/"
                                   target="_blank">Apache CarbonData 1.6.0</a></li>
                            <li>
                                <a href="https://dist.apache.org/repos/dist/release/carbondata/1.5.4/"
                                   target="_blank">Apache CarbonData 1.5.4</a></li>
                            <li>
                                <a href="https://dist.apache.org/repos/dist/release/carbondata/1.5.3/"
                                   target="_blank">Apache CarbonData 1.5.3</a></li>
                            <li>
                                <a href="https://dist.apache.org/repos/dist/release/carbondata/1.5.2/"
                                   target="_blank">Apache CarbonData 1.5.2</a></li>
                            <li>
                                <a href="https://dist.apache.org/repos/dist/release/carbondata/1.5.1/"
                                   target="_blank">Apache CarbonData 1.5.1</a></li>
                            <li>
                                <a href="https://dist.apache.org/repos/dist/release/carbondata/1.5.0/"
                                   target="_blank">Apache CarbonData 1.5.0</a></li>
                            <li>
                                <a href="https://dist.apache.org/repos/dist/release/carbondata/1.4.1/"
                                   target="_blank">Apache CarbonData 1.4.1</a></li>
                            <li>
                                <a href="https://cwiki.apache.org/confluence/display/CARBONDATA/Releases"
                                   target="_blank">Release Archive</a></li>
                        </ul>
                    </li>
                    <li><a href="documentation.html" class="active">Documentation</a></li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true"
                           aria-expanded="false">Community <span class="caret"></span></a>
                        <ul class="dropdown-menu">
                            <li>
                                <a href="https://github.com/apache/carbondata/blob/master/docs/how-to-contribute-to-apache-carbondata.md"
                                   target="_blank">Contributing to CarbonData</a></li>
                            <li>
                                <a href="https://github.com/apache/carbondata/blob/master/docs/release-guide.md"
                                   target="_blank">Release Guide</a></li>
                            <li>
                                <a href="https://cwiki.apache.org/confluence/display/CARBONDATA/PMC+and+Committers+member+list"
                                   target="_blank">Project PMC and Committers</a></li>
                            <li>
                                <a href="https://cwiki.apache.org/confluence/pages/viewpage.action?pageId=66850609"
                                   target="_blank">CarbonData Meetups</a></li>
                            <li><a href="security.html">Apache CarbonData Security</a></li>
                            <li><a href="https://issues.apache.org/jira/browse/CARBONDATA" target="_blank">Apache
                                Jira</a></li>
                            <li><a href="videogallery.html">CarbonData Videos </a></li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="http://www.apache.org/" class="apache_link hidden-xs dropdown-toggle"
                           data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Apache</a>
                        <ul class="dropdown-menu">
                            <li><a href="http://www.apache.org/" target="_blank">Apache Homepage</a></li>
                            <li><a href="http://www.apache.org/licenses/" target="_blank">License</a></li>
                            <li><a href="http://www.apache.org/foundation/sponsorship.html"
                                   target="_blank">Sponsorship</a></li>
                            <li><a href="http://www.apache.org/foundation/thanks.html" target="_blank">Thanks</a></li>
                        </ul>
                    </li>

                    <li class="dropdown">
                        <a href="http://www.apache.org/" class="hidden-lg hidden-md hidden-sm dropdown-toggle"
                           data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Apache</a>
                        <ul class="dropdown-menu">
                            <li><a href="http://www.apache.org/" target="_blank">Apache Homepage</a></li>
                            <li><a href="http://www.apache.org/licenses/" target="_blank">License</a></li>
                            <li><a href="http://www.apache.org/foundation/sponsorship.html"
                                   target="_blank">Sponsorship</a></li>
                            <li><a href="http://www.apache.org/foundation/thanks.html" target="_blank">Thanks</a></li>
                        </ul>
                    </li>

                    <li>
                        <a href="#" id="search-icon"><i class="fa fa-search" aria-hidden="true"></i></a>

                    </li>

                </ul>
            </div><!--/.nav-collapse -->
            <div id="search-box">
                <form method="get" action="http://www.google.com/search" target="_blank">
                    <div class="search-block">
                        <table border="0" cellpadding="0" width="100%">
                            <tr>
                                <td style="width:80%">
                                    <input type="text" name="q" size=" 5" maxlength="255" value=""
                                           class="search-input"  placeholder="Search...."    required/>
                                </td>
                                <td style="width:20%">
                                    <input type="submit" value="Search"/></td>
                            </tr>
                            <tr>
                                <td align="left" style="font-size:75%" colspan="2">
                                    <input type="checkbox" name="sitesearch" value="carbondata.apache.org" checked/>
                                    <span style=" position: relative; top: -3px;"> Only search for CarbonData</span>
                                </td>
                            </tr>
                        </table>
                    </div>
                </form>
            </div>
        </div>
    </nav>
</header> <!-- end Header part -->

<div class="fixed-padding"></div> <!--  top padding with fixde header  -->

<section><!-- Dashboard nav -->
    <div class="container-fluid q">
        <div class="col-sm-12  col-md-12 maindashboard">
            <div class="verticalnavbar">
                <nav class="b-sticky-nav">
                    <div class="nav-scroller">
                        <div class="nav__inner">
                            <a class="b-nav__intro nav__item" href="./introduction.html">introduction</a>
                            <a class="b-nav__quickstart nav__item" href="./quick-start-guide.html">quick start</a>
                            <a class="b-nav__uses nav__item" href="./usecases.html">use cases</a>

                            <div class="nav__item nav__item__with__subs">
                                <a class="b-nav__docs nav__item nav__sub__anchor" href="./language-manual.html">Language Reference</a>
                                <a class="nav__item nav__sub__item" href="./ddl-of-carbondata.html">DDL</a>
                                <a class="nav__item nav__sub__item" href="./dml-of-carbondata.html">DML</a>
                                <a class="nav__item nav__sub__item" href="./streaming-guide.html">Streaming</a>
                                <a class="nav__item nav__sub__item" href="./configuration-parameters.html">Configuration</a>
                                <a class="nav__item nav__sub__item" href="./datamap-developer-guide.html">Datamaps</a>
                                <a class="nav__item nav__sub__item" href="./supported-data-types-in-carbondata.html">Data Types</a>
                            </div>

                            <div class="nav__item nav__item__with__subs">
                                <a class="b-nav__datamap nav__item nav__sub__anchor" href="./datamap-management.html">DataMaps</a>
                                <a class="nav__item nav__sub__item" href="./bloomfilter-datamap-guide.html">Bloom Filter</a>
                                <a class="nav__item nav__sub__item" href="./lucene-datamap-guide.html">Lucene</a>
                                <a class="nav__item nav__sub__item" href="./preaggregate-datamap-guide.html">Pre-Aggregate</a>
                                <a class="nav__item nav__sub__item" href="./timeseries-datamap-guide.html">Time Series</a>
                                <a class="nav__item nav__sub__item" href="./mv-datamap-guide.html">MV</a>
                            </div>

                            <div class="nav__item nav__item__with__subs">
                                <a class="b-nav__api nav__item nav__sub__anchor" href="./sdk-guide.html">API</a>
                                <a class="nav__item nav__sub__item" href="./sdk-guide.html">Java SDK</a>
                                <a class="nav__item nav__sub__item" href="./CSDK-guide.html">C++ SDK</a>
                            </div>

                            <a class="b-nav__perf nav__item" href="./performance-tuning.html">Performance Tuning</a>
                            <a class="b-nav__s3 nav__item" href="./s3-guide.html">S3 Storage</a>
                            <a class="b-nav__indexserver nav__item" href="./index-server.html">Index Server</a>
                            <a class="b-nav__faq nav__item" href="./faq.html">FAQ</a>
                            <a class="b-nav__contri nav__item" href="./how-to-contribute-to-apache-carbondata.html">Contribute</a>
                            <a class="b-nav__security nav__item" href="./security.html">Security</a>
                            <a class="b-nav__release nav__item" href="./release-guide.html">Release Guide</a>
                        </div>
                    </div>
                    <div class="navindicator">
                        <div class="b-nav__intro navindicator__item"></div>
                        <div class="b-nav__quickstart navindicator__item"></div>
                        <div class="b-nav__uses navindicator__item"></div>
                        <div class="b-nav__docs navindicator__item"></div>
                        <div class="b-nav__datamap navindicator__item"></div>
                        <div class="b-nav__api navindicator__item"></div>
                        <div class="b-nav__perf navindicator__item"></div>
                        <div class="b-nav__s3 navindicator__item"></div>
                        <div class="b-nav__indexserver navindicator__item"></div>
                        <div class="b-nav__faq navindicator__item"></div>
                        <div class="b-nav__contri navindicator__item"></div>
                        <div class="b-nav__security navindicator__item"></div>
                    </div>
                </nav>
            </div>
            <div class="mdcontent">
                <section>
                    <div style="padding:10px 15px;">
                        <div id="viewpage" name="viewpage">
                            <div class="row">
                                <div class="col-sm-12  col-md-12">
                                    <div>
<h1>
<a id="carbondata-mv-datamap" class="anchor" href="#carbondata-mv-datamap" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>CarbonData MV DataMap</h1>
<ul>
<li><a href="#quick-example">Quick Example</a></li>
<li><a href="#mv-datamap-introduction">MV DataMap</a></li>
<li><a href="#loading-data">Loading Data</a></li>
<li><a href="#querying-data">Querying Data</a></li>
<li><a href="#compacting-mv-datamap">Compaction</a></li>
<li><a href="#data-management-with-mv-tables">Data Management</a></li>
</ul>
<h2>
<a id="quick-example" class="anchor" href="#quick-example" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Quick example</h2>
<p>Start spark-sql in terminal and run the following queries,</p>
<pre><code>CREATE TABLE maintable(a int, b string, c int) stored by 'carbondata';
insert into maintable select 1, 'ab', 2;
CREATE DATAMAP datamap_1 on table maintable as SELECT a, sum(b) from maintable group by a;
SELECT a, sum(b) from maintable group by a;
// NOTE: run explain query and check if query hits the datamap table from the plan
EXPLAIN SELECT a, sum(b) from maintable group by a;
</code></pre>
<h2>
<a id="mv-datamap-introduction" class="anchor" href="#mv-datamap-introduction" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>MV DataMap Introduction</h2>
<p>MV tables are created as DataMaps and managed as tables internally by CarbonData. User can create
limitless MV datamaps on a table to improve query performance provided the storage requirements
and loading time is acceptable.</p>
<p>MV datamap can be a lazy or a non-lazy datamap. Once MV datamaps are created, CarbonData's
CarbonAnalyzer helps to select the most efficient MV datamap based on the user query and rewrite
the SQL to select the data from MV datamap instead of main table. Since the data size of MV
datamap is smaller and data is pre-processed, user queries are much faster.</p>
<p>For instance, main table called <strong>sales</strong> which is defined as</p>
<pre><code>CREATE TABLE sales (
  order_time timestamp,
  user_id string,
  sex string,
  country string,
  quantity int,
  price bigint)
STORED AS carbondata
</code></pre>
<p>User can create MV tables using the Create DataMap DDL</p>
<pre><code>CREATE DATAMAP agg_sales
ON TABLE sales
USING "MV"
AS
  SELECT country, sex, sum(quantity), avg(price)
  FROM sales
  GROUP BY country, sex
</code></pre>
<p><strong>NOTE</strong>:</p>
<ul>
<li>
<p>Group by/Filter columns has to be provided in projection list while creating mv datamap</p>
</li>
<li>
<p>If only single parent table is involved in mv datamap creation, then TableProperties of Parent table
(if not present in a aggregate function like sum(col)) listed below will be
inherited to datamap table</p>
<ol>
<li>SORT_COLUMNS</li>
<li>SORT_SCOPE</li>
<li>TABLE_BLOCKSIZE</li>
<li>FLAT_FOLDER</li>
<li>LONG_STRING_COLUMNS</li>
<li>LOCAL_DICTIONARY_ENABLE</li>
<li>LOCAL_DICTIONARY_THRESHOLD</li>
<li>LOCAL_DICTIONARY_EXCLUDE</li>
<li>DICTIONARY_INCLUDE</li>
<li>DICTIONARY_EXCLUDE</li>
<li>INVERTED_INDEX</li>
<li>NO_INVERTED_INDEX</li>
<li>COLUMN_COMPRESSOR</li>
</ol>
</li>
<li>
<p>All columns of main table at once cannot participate in mv datamap table creation</p>
</li>
<li>
<p>TableProperties can be provided in DMProperties excluding LOCAL_DICTIONARY_INCLUDE,
LOCAL_DICTIONARY_EXCLUDE, DICTIONARY_INCLUDE, DICTIONARY_EXCLUDE, INVERTED_INDEX,
NO_INVERTED_INDEX, SORT_COLUMNS, LONG_STRING_COLUMNS, RANGE_COLUMN &amp; COLUMN_META_CACHE</p>
</li>
<li>
<p>TableProperty given in DMProperties will be considered for mv creation, eventhough if same
property is inherited from parent table, which allows user to provide different tableproperties
for child table</p>
</li>
<li>
<p>MV creation with limit or union all ctas queries is unsupported</p>
</li>
</ul>
<h4>
<a id="how-mv-tables-are-selected" class="anchor" href="#how-mv-tables-are-selected" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>How MV tables are selected</h4>
<p>When a user query is submitted, during query planning phase, CarbonData will collect modular plan
candidates and process the the ModularPlan based on registered summary data sets. Then,
mv datamap table for this query will be selected among the candidates.</p>
<p>For the main table <strong>sales</strong> and mv table  <strong>agg_sales</strong> created above, following queries</p>
<pre><code>SELECT country, sex, sum(quantity), avg(price) from sales GROUP BY country, sex

SELECT sex, sum(quantity) from sales GROUP BY sex

SELECT avg(price), country from sales GROUP BY country
</code></pre>
<p>will be transformed by CarbonData's query planner to query against mv table
<strong>agg_sales</strong> instead of the main table <strong>sales</strong></p>
<p>However, for following queries</p>
<pre><code>SELECT user_id, country, sex, sum(quantity), avg(price) from sales GROUP BY user_id, country, sex

SELECT sex, avg(quantity) from sales GROUP BY sex

SELECT country, max(price) from sales GROUP BY country
</code></pre>
<p>will query against main table <strong>sales</strong> only, because it does not satisfy mv table
selection logic.</p>
<h2>
<a id="loading-data" class="anchor" href="#loading-data" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Loading data</h2>
<h3>
<a id="loading-data-to-non-lazy-mv-datamap" class="anchor" href="#loading-data-to-non-lazy-mv-datamap" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Loading data to Non-Lazy MV Datamap</h3>
<p>In case of WITHOUT DEFERRED REBUILD, for existing table with loaded data, data load to MV table will
be triggered by the CREATE DATAMAP statement when user creates the MV table.
For incremental loads to main table, data to datamap will be loaded once the corresponding main
table load is completed.</p>
<h3>
<a id="loading-data-to-lazy-mv-datamap" class="anchor" href="#loading-data-to-lazy-mv-datamap" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Loading data to Lazy MV Datamap</h3>
<p>In case of WITH DEFERRED REBUILD, data load to MV table will be triggered by the <a href="./datamap-management.html#manual-refresh">Manual Refresh</a>
command. MV datamap will be in DISABLED state in below scenarios,</p>
<ul>
<li>when mv datamap is created</li>
<li>when data of main table and datamap are not in sync</li>
</ul>
<p>User should fire REBUILD DATAMAP command to sync all segments of main table with datamap table and
which ENABLES the datamap for query</p>
<h3>
<a id="loading-data-to-multiple-mvs" class="anchor" href="#loading-data-to-multiple-mvs" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Loading data to Multiple MV's</h3>
<p>During load to main table, if anyone of the load to datamap table fails, then that corresponding
datamap will be DISABLED and load to other datamaps mapped to main table will continue. User can
fire REBUILD DATAMAP command to sync or else the subsequent table load will load the old failed
loads along with current load and enable the disabled datamap.</p>
<p><strong>NOTE</strong>:</p>
<ul>
<li>In case of InsertOverwrite/Update operation on parent table, all segments of datamap table will
be MARKED_FOR_DELETE and reload to datamap table will happen by REBUILD DATAMAP, in case of Lazy
mv datamap/ once InsertOverwrite/Update operation on parent table is finished, in case of
Non-Lazy mv.</li>
<li>In case of full scan query, Data Size and Index Size of main table and child table will not the
same, as main table and child table has different column names.</li>
</ul>
<h2>
<a id="querying-data" class="anchor" href="#querying-data" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Querying data</h2>
<p>As a technique for query acceleration, MV tables cannot be queried directly.
Queries are to be made on main table. While doing query planning, internally CarbonData will check
associated mv datamap tables with the main table, and do query plan transformation accordingly.</p>
<p>User can verify whether a query can leverage mv datamap table or not by executing <code>EXPLAIN</code>
command, which will show the transformed logical plan, and thus user can check whether mv datamap
table is selected.</p>
<h2>
<a id="compacting-mv-datamap" class="anchor" href="#compacting-mv-datamap" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Compacting MV datamap</h2>
<h3>
<a id="compacting-mv-datamap-table-through-main-table-compaction" class="anchor" href="#compacting-mv-datamap-table-through-main-table-compaction" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Compacting MV datamap table through Main Table compaction</h3>
<p>Running Compaction command (<code>ALTER TABLE COMPACT</code>)[COMPACTION TYPE-&gt; MINOR/MAJOR] on main table will
automatically compact the mv datamap tables created on the main table, once compaction on main table
is done.</p>
<h3>
<a id="compacting-mv-datamap-table-through-ddl-command" class="anchor" href="#compacting-mv-datamap-table-through-ddl-command" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Compacting MV datamap table through DDL command</h3>
<p>Compaction on mv datamap can be triggered by running the following DDL command(supported only for mv).</p>
<pre><code>ALTER DATAMAP datamap_name COMPACT 'COMPACTION_TYPE'
</code></pre>
<h2>
<a id="data-management-with-mv-tables" class="anchor" href="#data-management-with-mv-tables" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Data Management with mv tables</h2>
<p>In current implementation, data consistency needs to be maintained for both main table and mv datamap
tables. Once there is mv datamap table created on the main table, following command on the main
table is not supported:</p>
<ol>
<li>Data management command: <code>DELETE SEGMENT</code>.</li>
<li>Schema management command: <code>ALTER TABLE DROP COLUMN</code>, <code>ALTER TABLE CHANGE DATATYPE</code>,
<code>ALTER TABLE RENAME</code>, <code>ALTER COLUMN RENAME</code>. Note that adding a new column is supported, and for
dropping columns and change datatype command, CarbonData will check whether it will impact the
mv datamap table, if not, the operation is allowed, otherwise operation will be rejected by
throwing exception.</li>
<li>Partition management command: <code>ALTER TABLE ADD/DROP PARTITION</code>. Note that dropping a partition
will be allowed only if partition is participating in all datamaps associated with main table.
Drop Partition is not allowed, if any mv datamap is associated with more than one parent table.
Drop Partition directly on datamap table is not allowed.</li>
<li>Complex Datatype's for mv datamap is not supported.</li>
</ol>
<p>However, there is still way to support these operations on main table, in current CarbonData
release, user can do as following:</p>
<ol>
<li>Remove the mv datamap table by <code>DROP DATAMAP</code> command</li>
<li>Carry out the data management operation on main table</li>
<li>Create the mv datamap table again by <code>CREATE DATAMAP</code> command
Basically, user can manually trigger the operation by re-building the datamap.</li>
</ol>
<script>
$(function() {
  // Show selected style on nav item
  $('.b-nav__datamap').addClass('selected');

  if (!$('.b-nav__datamap').parent().hasClass('nav__item__with__subs--expanded')) {
    // Display datamap subnav items
    $('.b-nav__datamap').parent().toggleClass('nav__item__with__subs--expanded');
  }
});
</script></div>
</div>
</div>
</div>
<div class="doc-footer">
    <a href="#top" class="scroll-top">Top</a>
</div>
</div>
</section>
</div>
</div>
</div>
</section><!-- End systemblock part -->
<script src="js/custom.js"></script>
</body>
</html>